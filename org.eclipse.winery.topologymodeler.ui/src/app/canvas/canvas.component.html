<!--
 * Copyright (c) 2017 Contributors to the Eclipse Foundation
 *
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0, or the Apache Software License 2.0
 * which is available at https://www.apache.org/licenses/LICENSE-2.0.
 *
 * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
-->

<div id="container" style="height: auto;"
     (mousedown)="showSelectionRange($event)"
     (click)="this.revalidateContainer()">
    <div id="grid"
         (mousedown)="trackTimeOfMouseDown()"
         (mouseup)="trackTimeOfMouseUp()"
         [class.crosshair]="this.gridTemplate.crosshair"
         [style.width.vw]="this.gridTemplate.gridDimension"
         [style.height.vh]="this.gridTemplate.gridDimension">
        <div class="selection" id="selection"
             [class.selection-active]="this.gridTemplate.selectionActive"
             [style.left.px]="this.gridTemplate.pageX"
             [style.top.px]="this.gridTemplate.pageY"
             [style.width.px]="this.gridTemplate.selectionWidth"
             [style.height.px]="this.gridTemplate.selectionHeight"
             #selection>
            <span></span>
        </div>
    </div>
    <div #nodes>
        <winery-node *ngFor="let nodeTemplate of allNodeTemplates"
                     [nodeTemplate]="nodeTemplate"
                     [entityTypes]="this.entityTypes"
                     [allRelationshipTypesColors]="allRelationshipTypesColors"
                     (sendId)="activateNewNode($event)"
                     [navbarButtonsState]="navbarButtonsState"
                     (askForRepaint)="revalidateContainer($event)"
                     (askForRemoval)="removeElement($event)"
                     (setDragSource)="setDragSource($event)"
                     (closedEndpoint)="toggleClosedEndpoint($event)"
                     (sendCurrentType)="setCurrentType($event)"
                     [dragSource]="nodeTemplate.id + '_Endpoint'"
                     (handleNodeClickedActions)="handleNodeClickedActions($event)"
                     (updateSelectedNodes)="updateSelectedNodes($event)"
                     (unmarkConnections)="unmarkConnections()"
                     (sendNodeData)="toggleModalHandler($event)">
        </winery-node>
    </div>
</div>

<!-- POLICIES MODAL -->
<winery-modal bsModal #policiesModal="bs-modal" [modalRef]="policiesModal">
    <winery-modal-header [title]="'Add Policy'">
    </winery-modal-header>
    <winery-modal-body>
        <form #addPolicyForm="ngForm" id="addPolicyForm" enctype="multipart/form-data">
            <fieldset>
                <div class="form-group">
                    <label for="policyName" class="control-label">Name:</label>
                    <input [(ngModel)]="policies.policyTemplateName" id="policyName" class="form-control" name="Name"
                           type="text" required/>
                </div>

                <div class="form-group">
                    <label for="policyType" class="control-label">Type:</label>
                    <select [(ngModel)]="policies.policyType"
                            id="policyType"
                            name="policyType"
                            class="form-control"
                            type="text"
                            required
                            (change)="onChangePolicyType($event.target.value)">
                        <option *ngFor="let policyType of policies.policyTypes" [value]="policyType.qName">
                            {{policyType.id}}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="policyTemplate" class="control-label">Policy Template:</label>

                    <select id="policyTemplate"
                            [(ngModel)]="policies.policyTemplate"
                            class="form-control"
                            name="policyTemplate"
                            (change)="onChangePolicyTemplate($event.target.value)">
                        <option *ngFor="let policyTemplate of policies.policyTemplates" [value]="policyTemplate.qName">
                            {{policyTemplate.id}}
                        </option>
                    </select>
                </div>

                <div>
                    <div id="OrionpolicyXML" class="orionxmleditordiv">
                        <pre></pre>
                    </div>
                </div>
            </fieldset>
        </form>
    </winery-modal-body>
    <winery-modal-footer [showDefaultButtons]="false">
        <button type="button" id="cancelPolicies" class="btn btn-default" (click)="resetPolicies()">Cancel</button>
        <button type="button" id="addPolicy" class="btn btn-primary" (click)="savePoliciesToModel()">Add</button>
    </winery-modal-footer>
</winery-modal>

<!-- CAPABILITIES MODAL -->
<winery-modal bsModal #capabilitiesModal="bs-modal" [modalRef]="capabilitiesModal">
    <winery-modal-header [title]="'Add Capability'">
    </winery-modal-header>
    <winery-modal-body>
        <form #addCapForm="ngForm" id="addCapForm" enctype="multipart/form-data">
            <fieldset>

                <div class="form-group" id="CapIdGroup">
                    <label for="CapId" class="control-label">Id:</label>
                    <input [(ngModel)]="capabilities.capId"
                           id="CapId"
                           class="form-control"
                           name="CapId"
                           type="text"
                           required="required"
                           (change)="onChangeCapId($event.target.value)"/>
                </div>

                <div class="form-group">
                    <label for="CapNameChooser" class="control-label">Definition Name:</label>
                    <select [(ngModel)]="capabilities.capDefinitionName"
                            name="capName"
                            id="CapNameChooser"
                            class="form-control"
                            type="text"
                            required="required"
                            (change)="onChangeCapDefinitionName($event.target.value)">
                        <option *ngFor="let capDefinitionName of capabilities.capDefinitionNames"
                                [value]="capDefinitionName.name">{{ capDefinitionName.name }}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="CapTypeDisplay" class="control-label">Cap Type:</label>
                    <input id="CapTypeDisplay"
                           class="form-control"
                           type="text"
                           required="required"
                           name="CapTypeDisplay"
                           disabled="disabled"
                           [(ngModel)]="capabilities.capQName"/>
                </div>

                <div id="CapPropertiesContainer">
                </div>
            </fieldset>
        </form>
    </winery-modal-body>
    <winery-modal-footer [showDefaultButtons]="false">
        <button type="button" id="cancelCapabilities" class="btn btn-default" (click)="resetCapabilities()">Cancel
        </button>
        <button (click)="saveCapabilityToModel()" type="button" id="addCapbtn" class="btn btn-primary">Add</button>
    </winery-modal-footer>
</winery-modal>

<!-- REQUIREMENTS MODAL -->
<winery-modal bsModal #requirementsModal="bs-modal" [modalRef]="requirementsModal">
    <winery-modal-header [title]="'Add Requirement'">
    </winery-modal-header>
    <winery-modal-body>
        <form #addReqForm="ngForm" id="addReqForm" enctype="multipart/form-data">
            <fieldset>

                <div class="form-group" id="ReqIdGroup">
                    <label for="ReqId" class="control-label">Id:</label>
                    <input [(ngModel)]="requirements.reqId"
                           id="ReqId"
                           class="form-control"
                           name="ReqId"
                           type="text"
                           required="required"
                           (change)="onChangeReqId($event.target.value)"/>
                </div>

                <div class="form-group">
                    <label for="ReqNameChooser" class="control-label">Definition Name:</label>
                    <select [(ngModel)]="requirements.reqDefinitionName"
                            id="ReqNameChooser"
                            name="ReqNameChooser"
                            class="form-control"
                            type="text"
                            required="required"
                            (change)="onChangeReqDefinitionName($event.target.value)">
                        <option *ngFor="let reqDefinitionName of requirements.reqDefinitionNames"
                                [value]="reqDefinitionName.name">
                            {{reqDefinitionName.name}}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ReqTypeDisplay" class="control-label">Req Type:</label>
                    <input [(ngModel)]="requirements.reqQName"
                           id="ReqTypeDisplay"
                           name="ReqTypeDisplay"
                           class="form-control"
                           type="text"
                           required="required"
                           disabled="disabled"/>
                </div>

                <div id="ReqPropertiesContainer">
                </div>
            </fieldset>
        </form>
    </winery-modal-body>
    <winery-modal-footer [showDefaultButtons]="false">
        <button type="button" id="cancelRequirements" class="btn btn-default" (click)="resetRequirements()">Cancel
        </button>
        <button (click)="saveRequirementsToModel()" type="button" id="addReqbtn" class="btn btn-primary">Add</button>
    </winery-modal-footer>
</winery-modal>

<!-- DEPLOYMENT ARTIFACT MODAL -->
<winery-modal bsModal #deploymentArtifactModal="bs-modal" [modalRef]="deploymentArtifactModal" [size]="'modal-lg'">
    <winery-modal-header [title]="'Add Deployment Artifact'">
    </winery-modal-header>
    <winery-modal-body>
        <form #addDeploymentArtifactForm="ngForm" id="addDeploymentArtifactForm" enctype="multipart/form-data">
            <fieldset>
                <div class="form-group">
                    <label>Name</label>
                    <input [(ngModel)]="deploymentArtifactModalData.artifactName" class="form-control"
                           name="artifactName"
                           required
                           id="artifactName" type="text" autocomplete="on"/>
                </div>
                <h4>Artifact Template Creation</h4>
                <div class="radio">
                    <label>
                        <input type="radio" name="artifactTemplateCreation" value="createArtifactTemplate"
                               checked="checked" id="createArtifactTemplateInput"
                               [(ngModel)]="deploymentArtifactSelectedRadioButton"/>Create Artifact Template
                    </label>
                    <p class="help-block">If you want to add files to this deployment artifact you can do so via <a
                        target="_blank" href="{{getHostUrl()+'#/nodetypeimplementations'}}">Winery's management UI</a>,
                        after creating this deployment artifact.</p>
                </div>
                <div class="radio">
                    <label>
                        <input type="radio" name="artifactTemplateCreation" value="linkArtifactTemplate"
                               id="linkArtifactTemplateInput"
                               [(ngModel)]="deploymentArtifactSelectedRadioButton"/>Link Artifact
                        Template
                    </label>
                    <p class="help-block">Check if you want to reuse existing files.</p>
                </div>
                <div class="radio">
                    <label>
                        <input type="radio" name="artifactTemplateCreation" value="skipArtifactTemplate"
                               id="skipArtifactTemplateInput"
                               [(ngModel)]="deploymentArtifactSelectedRadioButton"/>Do not create
                        an artifact template
                    </label>
                    <p class="help-block">Check if you want to point to an image library.</p>
                </div>
            </fieldset>
            <fieldset id="artifactTypeFieldset"
                      *ngIf="deploymentArtifactSelectedRadioButton === 'createArtifactTemplate'||
                            deploymentArtifactSelectedRadioButton === 'skipArtifactTemplate'">
                <div class="form-group" id="artifactTypeDiv">
                    <label for="artifactChooser">Artifact Type</label>
                    <select [(ngModel)]="deploymentArtifactModalData.artifactType"
                            name="artifactChooser"
                            class="form-control"
                            id="artifactChooser"
                            type="text"
                            required="required"
                            (change)="onChangeDeploymentArtifacts($event.target.value)">
                        <option *ngFor="let artifactType of deploymentArtifactModalData.artifactTypes"
                                [value]="artifactType.qName">{{artifactType.name}}
                        </option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <div class="form-group-grouping"
                     *ngIf="deploymentArtifactSelectedRadioButton === 'createArtifactTemplate'">
                    <!-- createArtifactTemplate class is required for artifactcreationdialog -->
                    <div class="form-group createArtifactTemplate">
                        <label>Artifact Template Name</label>
                        <!-- name is an NCName -->
                        <input [(ngModel)]="deploymentArtifactModalData.artifactTemplateName"
                               class="artifactData form-control"
                               id="artifactTemplateName" name="artifactTemplateName" type="text" required
                               autocomplete="on"
                               (keyup)="checkIfArtifactTemplateAlreadyExists($event)"
                               placeholder="Enter name for artifact template"
                               #artifactTemplateName="ngModel"/>
                        <div id="artifactTemplateNameIsValid" class="invalid">
                            <span id="artifactTemplateNameIsInvalidReason"></span>
                        </div>
                        <div class="alert alert-info"
                             *ngIf="artifactTemplateAlreadyExists && (artifactTemplateName.dirty || artifactTemplateName.touched) &&
                            artifactTemplateName.valid">
                            Artifact Template with this name already exists.
                        </div>
                        <div class="alert alert-success"
                             *ngIf="!artifactTemplateAlreadyExists && (artifactTemplateName.dirty || artifactTemplateName.touched) &&
                            artifactTemplateName.valid">
                            Will be created.
                        </div>

                    </div>

                    <!-- createArtifactTemplate class is required for artifactcreationdialog -->
                    <div class="form-group createArtifactTemplate">
                        <label for="artifactTemplateNS" class="control-label">Namespace</label>
                        <input [(ngModel)]="deploymentArtifactModalData.artifactTemplateNameSpace" type="text"
                               class="form-control"
                               name="artifactTemplateNS"
                               id="artifactTemplateNS"
                               (blur)="updateSelectedNamespaceInDeploymentArtifactModalData($event)"
                               [typeahead]="allNamespaces"
                               typeaheadOptionField="namespace"/>
                    </div>
                </div>
                <!-- linkArtifactTemplate -->
                <div id="linkArtifactTemplate" class="form-group"
                     *ngIf="deploymentArtifactSelectedRadioButton === 'linkArtifactTemplate'">
                    <label for="divArtifactTemplateToLink">Artifact Template</label>
                    <div id="divArtifactTemplateToLink">
                        <select id=artifactTemplateToLink name="artifactTemplate"
                                class="form-control"
                                required
                                (change)="updateDeploymentArtifactModalData($event.target.value)">
                            <option *ngFor="let artifactTemplate of deploymentArtifactModalData.artifactTemplates"
                                    [value]="artifactTemplate | json">
                                {{artifactTemplate.name}}
                            </option>
                        </select>

                        <a href="#" target="_blank" class="btn btn-info btn-sm" id="viewArtifactTemplateToLink">open</a>
                    </div>
                </div>
            </fieldset>
        </form>
    </winery-modal-body>
    <winery-modal-footer [showDefaultButtons]="false">
        <button type="button" id="cancelDeploymentArtifacts" class="btn btn-default"
                (click)="resetDeploymentArtifactModalData()">Cancel
        </button>
        <button type="button" class="btn btn-primary" [disabled]="addDeploymentArtifactForm.form.invalid"
                (click)="addDeploymentArtifactConfirmed()">Add
        </button>
    </winery-modal-footer>
</winery-modal>
