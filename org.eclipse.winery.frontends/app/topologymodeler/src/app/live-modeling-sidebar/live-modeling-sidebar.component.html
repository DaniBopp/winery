<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ Copyright (c) 2019 Contributors to the Eclipse Foundation
  ~
  ~ See the NOTICE file(s) distributed with this work for additional
  ~ information regarding copyright ownership.
  ~
  ~ This program and the accompanying materials are made available under the
  ~ terms of the Eclipse Public License 2.0 which is available at
  ~ http://www.eclipse.org/legal/epl-2.0, or the Apache Software License 2.0
  ~ which is available at https://www.apache.org/licenses/LICENSE-2.0.
  ~
  ~ SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

<div class="live-modeling-sidebar-root"
     mwlResizable
     [validateResize]="validateResize"
     [enableGhostResize]="true"
     [resizeEdges]="{bottom: false, right: false, top: false, left: true}"
     (resizeEnd)="onResizeEnd($event)"
     [style.width.px]="sidebarButtonState === 'top' ? this.sidebarWidth : toggleButton.offsetHeight"
     [style.paddingTop.px]="this.top">
    <button [@sidebarButtonState]="sidebarButtonState" id="toggleButton" class="btn btn-primary" type="button"
            (click)="toggleSidebarState()"
            #toggleButton>
        <span>Live-Modeling </span>
        <span [hidden]="liveModelingState === liveModelingStates.DISABLED" class="fa-stack fa-1x">
          <i class="fa fa-circle fa-stack-1x" style="color: red; opacity: 0.5; font-size: 1.6em"></i>
          <i class="fa fa-circle fa-stack-1x" style="color: red"></i>
        </span>
    </button>
    <div [@sidebarContentState]="sidebarContentState" class="live-modeling-sidebar-content">
        <div *ngIf="liveModelingState === liveModelingStates.DISABLED" class="live-modeling-sidebar-page start-page">
            <p>Live modeling is currently disabled.</p>
            <button class="btn btn-warning font-weight-bold"
                    (click)="unsavedChanges() ? openModal(confirmUnsavedChangesModal) : enableLiveModeling()">Enable
            </button>
        </div>
        <div *ngIf="liveModelingState !== liveModelingStates.DISABLED" class="live-modeling-sidebar-page live-page">
            <div class="live-modeling-sidebar-section">
                <div class="d-flex">
                    <label class="live-modeling-sidebar-section-label flex-grow-1">General</label>
                    <i class="fa fa-gear ml-2" style="cursor: pointer;" tooltip="Settings" placement="left"
                       (click)="openModal(settingsModal)"></i>
                    <i class="fa fa-times ml-2" style="cursor: pointer;" tooltip="Disable Live-modeling"
                       placement="left"
                       (click)="disableLiveModeling()"></i>
                </div>
                <div class="d-flex">
                    <div class="d-flex align-items-center justify-content-center icon-container">
                        <div *ngIf="currentCsar?.icon_url; then icon else iconPlaceholder"></div>
                        <ng-template #icon>
                            <img [src]="currentCsar.icon_url">
                        </ng-template>
                        <ng-template #iconPlaceholder>
                            <div class="icon-placeholder"></div>
                        </ng-template>
                    </div>
                    <div class="d-flex flex-column justify-content-center ml-2">
                        <div *ngIf="currentCsar?.name; then csarName else csarNamePlaceholder"></div>
                        <ng-template #csarName>
                            <span class="font-weight-bold">{{currentCsar.name}}</span>
                        </ng-template>
                        <ng-template #csarNamePlaceholder>
                            <div class="text-placeholder" style="width: 60px"></div>
                        </ng-template>
                        <div
                            *ngIf="currentCsar?.description; then csarDescription else csarDescriptionPlaceholder"></div>
                        <ng-template #csarDescription>
                            <span>{{currentCsar.description}}</span>
                        </ng-template>
                        <ng-template #csarDescriptionPlaceholder>
                            <div class="text-placeholder" style="width: 120px"></div>
                        </ng-template>
                        <div *ngIf="currentCsar?.version; then csarVersion else csarVersionPlaceholder"></div>
                        <ng-template #csarVersion>
                            <span class="font-italic">Version: {{currentCsar.version}}</span>
                        </ng-template>
                        <ng-template #csarVersionPlaceholder>
                            <div class="text-placeholder" style="width: 40px"></div>
                        </ng-template>
                    </div>
                </div>
            </div>
            <div class="live-modeling-sidebar-section">
                <label class="live-modeling-sidebar-section-label">Buildplan</label>
                <div class="table-scrollable">
                    <table class="table table-dark">
                        <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Value</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let parameter of buildPlanInputParameters">
                            <td>{{parameter.name}}</td>
                            <td>{{parameter.value || '(empty)'}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="live-modeling-sidebar-section">
                <label class="live-modeling-sidebar-section-label">Instance</label>
                <div class="my-2">
                    <span>Instance Id: </span>
                    <span class="font-weight-bold">{{serviceTemplateInstanceId}}</span>
                </div>
                <div class="my-2">
                    <span>State: </span>
                    <span class="badge-small"
                          [style.background]="getBadgeBackgroundForState(serviceTemplateInstanceState)">{{serviceTemplateInstanceState | uppercase }}
                    </span>
                    <i class="fa fa-refresh ml-2" style="cursor: pointer;" tooltip="Refresh state" placement="top"
                       [class.disable-icon]="updatingServiceTemplateInstanceState"
                       [class.fa-spin]="updatingServiceTemplateInstanceState"
                       (click)="updateServiceTemplateInstanceState()"></i>
                </div>
                <div class="d-flex">
                    <button class="btn btn-info"
                            [disabled]="liveModelingState !== liveModelingStates.ENABLED && liveModelingState !== liveModelingStates.ERROR"
                            (click)="deployNewInstance()"
                            tooltip="Deploy new instance"
                            placement="bottom">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button class="btn btn-danger ml-2"
                            [disabled]="liveModelingState !== liveModelingStates.ENABLED"
                            (click)="openModal(confirmTerminationModal)"
                            tooltip="Terminate instance"
                            placement="bottom">
                        <i class="fa fa-minus-circle"></i>
                    </button>
                    <button class="btn btn-info ml-2"
                            [disabled]="liveModelingState !== liveModelingStates.ENABLED"
                            (click)="refresh()"
                            tooltip="Refresh node template data"
                            placement="bottom">
                        <i class="fa fa-refresh"></i>
                    </button>
                    <button class="btn btn-info ml-2"
                            [disabled]="liveModelingState !== liveModelingStates.ENABLED"
                            (click)="openSwitchInstanceModal(switchInstanceModal)"
                            tooltip="Switch Service Template Instance"
                            placement="bottom">
                        <i class="fa fa-exchange"></i>
                    </button>
                </div>
            </div>
            <div class="live-modeling-sidebar-section d-flex flex-column">
                <div class="d-flex justify-content-end pb-1">
                    <!--                    <i class="fa fa-filter" style="cursor: pointer;" tooltip="Filter logs" placement="left"></i>-->
                    <i class="fa fa-trash ml-2" style="cursor: pointer;" tooltip="Clear logs" placement="left"
                       (click)="clearLogs()"></i>
                </div>
                <div #scrollContainer (scroll)="scrolled()" class="scroll-container">
                    <div class="log-container">
                        <div #logItems *ngFor="let log of logs; let last = last" class="log-item">
                            <span class="log-timestamp">{{log.timestamp}}</span>
                            <span class="log-message">
                                <span class="badge-xsmall"
                                      [style.background]="getBadgeBackgroundForLog(log.type)">{{log.type | uppercase }}</span>
                                {{log.message}}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="progressbar-container">
                    <progressbar *ngIf="showProgressbar" class="progress-striped active" value="100"></progressbar>
                </div>
            </div>
        </div>
    </div>
</div>


<ng-template #confirmTerminationModal>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Confirm Termination</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="dismissModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        Do you want to terminate this instance?
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="dismissModal()">Close</button>
        <button type="button" class="btn btn-danger" (click)="terminate()">Yes</button>
    </div>
</ng-template>

<ng-template #settingsModal>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Live-Modeling Settings</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="dismissModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div *ngFor="let key of objectKeys(settings)" class="pb-2">
            <label class="font-weight-normal" [for]="key">{{key}}:</label>
            <input class="form-control" type="text" [id]="key"
                   [(ngModel)]="settings[key]">
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="dismissModal()">Close</button>
        <button type="button" class="btn btn-primary" (click)="setSettings()">Save</button>
    </div>
</ng-template>

<ng-template #confirmUnsavedChangesModal>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Unsaved Changes</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="dismissModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        You have unsaved changes made to the topology. In order to continue, save the current template and try again.
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="dismissModal()">Close</button>
        <button type="button" class="btn btn-primary" (click)="saveTopologyAndEnableLiveModeling()">Save and Continue
        </button>
    </div>
</ng-template>


<ng-template #switchInstanceModal>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Switch Service Template Instance</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="dismissModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="d-flex">
            <div class="btn-group mr-2 dropdown flex-grow-1" dropdown
                 [isDisabled]="!(serviceTemplateInstanceIds && serviceTemplateInstanceIds?.length > 0)">
                <button id="button-basic" dropdownToggle type="button" class="btn btn-light dropdown-toggle"
                        aria-controls="dropdown-basic">
                    Service Template Instance ID: <b>{{selectedServiceTemplateInstanceId}}</b>
                </button>
                <ul id="dropdown-basic" *dropdownMenu class="dropdown-menu"
                    role="menu" aria-labelledby="button-basic">
                    <li *ngFor="let id of serviceTemplateInstanceIds" role="menuitem">
                        <span class="dropdown-item" (click)="selectServiceTemplateId(id)">{{id}}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="dismissModal()">Close</button>
        <button type="button" class="btn btn-primary" 
                [disabled]="selectedServiceTemplateInstanceId === serviceTemplateInstanceId"
                (click)="switchServiceTemplateInstance()">
            Switch
        </button>
    </div>
</ng-template>
