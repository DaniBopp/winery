<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ Copyright (c) 2018-2019 Contributors to the Eclipse Foundation
  ~
  ~ See the NOTICE file(s) distributed with this work for additional
  ~ information regarding copyright ownership.
  ~
  ~ This program and the accompanying materials are made available under the
  ~ terms of the Eclipse Public License 2.0 which is available at
  ~ http://www.eclipse.org/legal/epl-2.0, or the Apache Software License 2.0
  ~ which is available at https://www.apache.org/licenses/LICENSE-2.0.
  ~
  ~ SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<form #configurationForm="ngForm">
    <div *ngIf="!loading; else showLoader">
        <div *ngIf="!error; else showError">
            <div class="form-group">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="enableAccountability" name="enableAccountability"
                               [(ngModel)]="configuration.enableAccountability">
                        Enable Accountability Tracking
                    </label>
                </div>
                <br/>

                <div *ngIf="configuration.enableAccountability" style="margin-bottom: 10px;">
                    <label for="blockchainNodeUrl">Geth JSON-RPC API URL (with port number)</label>
                    <input type="text" id="blockchainNodeUrl" class="form-control" name="blockchainNodeUrl"
                           [(ngModel)]="configuration.blockchainNodeUrl" required>
                    <br/>

                    <label for="swarmGatewayURL">Swarm HTTP Gateway URL (without port number)</label>
                    <input type="text" id="swarmGatewayURL" class="form-control" name="swarmGatewayURL"
                           [(ngModel)]="configuration.swarmGatewayUrl" required>
                    <br/>

                    <label for="keystorePathOnServer">Active Keystore</label>
                    <input type="text" id="keystorePathOnServer" class="form-control" name="keystorePathOnServer"
                           [(ngModel)]="configuration.activeKeystore" readonly="readonly">
                    <button type="button" class="btn-link"
                            (click)="onCreateNewKeystore(createKeystoreModal)"
                            [disabled]="loading">
                        Create New Keystore File
                    </button>
                    <br />

                    <label for="fileUploader">Change Keystore (will be uploaded when clicking on "Save")</label>
                    <input type="file" id="fileUploader" name="fileUploader"
                           (change)="keyStoreSelected($event.target.files)"/>
                    <br/>

                    <label for="keystorePassword">Keystore Password (Caution: password is transmitted in
                        plaintext!)</label>
                    <input type="password" id="keystorePassword" class="form-control" name="keystorePassword"
                           [(ngModel)]="configuration.keystorePassword" required>
                    <br/>

                    <label for="provenanceSmartContract">Provenance Smart Contract Address</label>

                    <div class="form-inline" *ngIf="!deployingProvenanceSC; else showLoader">
                        <input type="text" id="provenanceSmartContract" class="form-control"
                               name="provenanceSmartContract" style="width: 91%; margin-right: 1%;"
                               pattern="^0x[a-fA-F0-9]{40}$"
                               [(ngModel)]="configuration.provenanceSmartContractAddress">

                        <button type="button" class="btn btn-outline-secondary" style="width: 8%;"
                                (click)="onDeployProvenanceSmartContract()"
                                [disabled]="loading">
                            Deploy
                        </button>
                    </div>

                    <br/>

                    <label for="authorizationSmartContract">Authorization Smart Contract Address</label>

                    <div class="form-inline" *ngIf="!deployingAuthorizationSC; else showLoader">
                        <input type="text" id="authorizationSmartContract" class="form-control"
                               name="authorizationSmartContract" style="width: 91%; margin-right: 1%;"
                               pattern="^0x[a-fA-F0-9]{40}$"
                               [(ngModel)]="configuration.authorizationSmartContractAddress">
                        <button type="button" class="btn btn-outline-secondary"
                                (click)="onDeployAuthorizationSmartContract()"
                                [disabled]="loading" style="width: 8%;">
                            Deploy
                        </button>
                    </div>

                    <br/>

                    <label for="permissionsSmartContract">Permissions Smart Contract Address</label>

                    <div class="form-inline" *ngIf="!deployingPermissionsSC; else showLoader">
                        <input type="text" id="permissionsSmartContract" class="form-control"
                               name="permissionsSmartContract" style="width: 91%; margin-right: 1%;"
                               pattern="^0x[a-fA-F0-9]{40}$"
                               [(ngModel)]="configuration.permissionsSmartContractAddress">
                        <button type="button" class="btn btn-outline-secondary"
                                (click)="onDeployPermissionsSmartContract()"
                                [disabled]="loading" style="width: 8%;">
                            Deploy
                        </button>
                    </div>
                </div>

                <br/>

                <button type="button" class="btn btn-primary" (click)="onSave()"
                        [disabled]="(!configurationForm?.valid && configuration.enableAccountability) || loading">
                    Save
                </button>

                <button type="button" class="btn btn-primary" (click)="onRestore()" style="margin-left: 10px;"
                        [disabled]="loading">
                    Restore Defaults
                </button>
            </div>
        </div>
        <ng-template #showError>
            <alert [type]="'danger'">
                <i class="fa fa-ban"></i>
                <span>&nbsp;&nbsp;{{ error }}</span>
            </alert>
        </ng-template>
    </div>
    <ng-template #showLoader>
        <winery-loader></winery-loader>
    </ng-template>

</form>

<ng-template #createKeystoreModal>
    <winery-modal-header [modalRef]="modalRef" [title]="'Create New Blockchain Keystore'">-->
    </winery-modal-header>

    <winery-modal-body>
        <form #createKeystoreForm="ngForm">
            <label for="newKeystorePassword">Keystore Password (Caution: password is transmitted in
                plaintext!)</label>
            <input type="password" id="newKeystorePassword" class="form-control" name="newKeystorePassword"
                   [(ngModel)]="newPassword" required>
            <p style="padding: 5px;text-align: justify;">
                When clicking on 'Create' a new keystore file which is protected with the provided password will be generated. Afterwards it will be downloaded.
                <b>The generated keystore file will not be automatically set as the active keystore.</b> You need to do that manually.
            </p>
        </form>
    </winery-modal-body>
    <winery-modal-footer [modalRef]="modalRef" [showDefaultButtons]="true" [closeButtonLabel]="'Cancel'"  [okButtonLabel]="'Create'"  (onOk)="createNewKeystoreFile()"></winery-modal-footer>
</ng-template>
