<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ Copyright (c) 2018 Contributors to the Eclipse Foundation
  ~
  ~ See the NOTICE file(s) distributed with this work for additional
  ~ information regarding copyright ownership.
  ~
  ~ This program and the accompanying materials are made available under the
  ~ terms of the Eclipse Public License 2.0 which is available at
  ~ http://www.eclipse.org/legal/epl-2.0, or the Apache Software License 2.0
  ~ which is available at https://www.apache.org/licenses/LICENSE-2.0.
  ~
  ~ SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div [class.hidden]="!loading">
    <winery-loader></winery-loader>
</div>
<div *ngIf="!loading">
    <winery-table [columns]="columns[keystoreEntityType]"
                  [data]="data[keystoreEntityType]"
                  (cellSelected)="onCellSelect($event)"
                  (addBtnClicked)="onAddClick()"
                  [enableOtherPurposeButton]="true"
                  (otherPurposeBtnClicked)="onInfoClick()"
                  (removeBtnClicked)="onRemoveClick($event)">
    </winery-table>


    <winery-modal bsModal #addKeyModal="bs-modal" [modalRef]="addKeyModal">
        <winery-modal-header [title]="'Add Key'">
        </winery-modal-header>
        <winery-modal-body>
            <form #addKeyForm="ngForm" id="addKeyForm">
                <div class="form-group">
                    <label>Algorithm</label>
                    <ng-select #algoList
                               [items]="supportedAlgorithms"
                               (selected)="targetAlgorithmSelected($event)"
                               required
                               placeholder="no algorithm selected">
                    </ng-select>
                </div>
                <div *ngIf="addKeyData && addKeyData.algorithm">
                    <div class="form-group">
                        <label>Key Size</label>
                        <ng-select #keySizesList
                                   [items]="supportedAlgorithmsKeySizesMap[addKeyData.algorithm]"
                                   (selected)="targetKeySizeSelected($event)"
                                   required
                                   placeholder="no key size selected">
                        </ng-select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="keyUploader">Key file</label>
                    <input type="file" id="keyUploader" name="keyUploader" (change)="keySelected($event)"/>
                    <p class="help-block">File will be uploaded after clicking on "Save".</p>
                </div>
                <br/>
            </form>
        </winery-modal-body>
        <winery-modal-footer
            (onOk)="addKey(); addKeyForm.reset();"
            [closeButtonLabel]="'Cancel'"
            [okButtonLabel]="'Add'"
            [disableOkButton]="!addKeyForm?.form.valid">
        </winery-modal-footer>
    </winery-modal>

    <winery-modal bsModal #addKeypairModal="bs-modal" [modalRef]="addKeypairModal">
        <winery-modal-header [title]="'Add Keypair'">
        </winery-modal-header>
        <winery-modal-body>
            <form #addKeypairForm="ngForm" id="addKeypairForm">
                <div class="form-group">
                    <label>Algorithm</label>
                    <ng-select #algoList
                               [items]="supportedAlgorithms"
                               (selected)="targetAlgorithmSelected($event)"
                               required
                               placeholder="no algorithm selected">
                    </ng-select>
                </div>
                <div *ngIf="addKeypairData && addKeypairData.algorithm">
                    <div class="form-group">
                        <label>Key Size</label>
                        <ng-select #keySizesList
                                   [items]="supportedAlgorithmsKeySizesMap[addKeypairData.algorithm]"
                                   (selected)="targetKeySizeSelected($event)"
                                   required
                                   placeholder="no key size selected">
                        </ng-select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="commonName">Common Name (CN)</label>
                    <input type="text" id="commonName" name="commonName" class="form-control"
                           [(ngModel)]="this.addKeypairData.commonName"/>
                </div>
                <div class="form-group">
                    <label for="oName">Organization Name (O)</label>
                    <input type="text" id="oName" name="oName" class="form-control"
                           [(ngModel)]="this.addKeypairData.organizationName"/>
                </div>
                <div class="form-group">
                    <label for="countryName">Country Name (O)</label>
                    <input type="text" id="countryName" name="countryName" class="form-control"
                           [(ngModel)]="this.addKeypairData.countryName"/>
                </div>
                <div class="form-group">
                    <label for="privateKeyUploader">Private key file</label>
                    <input type="file" id="privateKeyUploader" name="privateKeyUploader"
                           (change)="keypairSelected($event)"/>
                    <p class="help-block">File will be uploaded after clicking on "Save".</p>
                </div>
                <div class="form-group">
                    <label for="certificateUploader">Certificate file</label>
                    <input type="file" id="certificateUploader" name="certificateUploader"
                           (change)="certificateSelected($event)"/>
                    <p class="help-block">File will be uploaded after clicking on "Save".</p>
                </div>
            </form>
        </winery-modal-body>
        <winery-modal-footer
            (onOk)="addKeypair(); addKeypairForm.reset();"
            [closeButtonLabel]="'Cancel'"
            [okButtonLabel]="'Add'"
            [disableOkButton]="!(this.addKeypairData.algorithm && (
                (this.addKeypairData.commonName && this.addKeypairData.organizationName && this.addKeypairData.countryName) ||
                (this.addKeypairData.privateKeyFile && this.addKeypairData.certificateFile))
            )">
        </winery-modal-footer>
    </winery-modal>

    <winery-modal bsModal #addCertificateModal="bs-modal" [modalRef]="addCertificateModal">
        <winery-modal-header [title]="'Add Certificate'">
        </winery-modal-header>
        <winery-modal-body>
            <form #addCertificateForm="ngForm" id="addCertificateForm">
                <div class="form-group">
                    <label for="certificateFileUploader">Certificate file</label>
                    <input type="file" id="certificateFileUploader" name="certificateFileUploader"
                           (change)="certificateSelected($event)"/>
                    <p class="help-block">File will be uploaded after clicking on "Save".</p>
                </div>
            </form>
        </winery-modal-body>
        <winery-modal-footer
            (onOk)="addCertificate(); addCertificateForm.reset();"
            [closeButtonLabel]="'Cancel'"
            [okButtonLabel]="'Add'"
            [disableOkButton]="!this.addCertificateData">
        </winery-modal-footer>
    </winery-modal>

    <winery-modal bsModal #confirmDeleteModal="bs-modal" [modalRef]="confirmDeleteModal">
        <winery-modal-header>
            <h4 class="modal-title">Delete Keystore Entity</h4>
        </winery-modal-header>
        <winery-modal-body>
            <p *ngIf="selectedCell != null" id="diagyesnomsg">
                Do you want to delete the following keystore entity <span style="font-weight:bold;">{{ selectedCell.row.alias}}</span>?
            </p>
        </winery-modal-body>
        <winery-modal-footer (onOk)="deleteEntity();"
                             [closeButtonLabel]="'No'"
                             [okButtonLabel]="'Delete'">
        </winery-modal-footer>
    </winery-modal>

    <winery-modal bsModal #keyInfoModal="bs-modal" [modalRef]="keyInfoModal">
        <winery-modal-header [title]="'Key Details'"></winery-modal-header>
        <winery-modal-body>
            <div *ngIf="selectedCell">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <label class="control-label">Key details</label>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <label class="col-sm-2 control-label">Alias:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.alias}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Algorithm:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.algorithm}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Format:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.keyFormat}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Size (in bits):</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.keySizeInBits}}</p>
                            </div>
                        </div>
                        <div *ngIf="selectedCell.row.base64Key" class="row">
                            <label class="col-sm-2 control-label">Base64 encoded:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.base64Key}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div [class.hidden]="!modalLoading">
                    <winery-loader></winery-loader>
                </div>
                <div *ngIf="!modalLoading">
                    <div *ngIf="selectedEntitySecPolicyTemplate; else generatePolicy">
                        <div class="update-nag">
                            <div class="update-split update-success"><i class="glyphicon glyphicon-ok"></i></div>
                            <div class="update-text">Encryption policy for this key is generated.</div>
                        </div>
                    </div>
                    <ng-template #generatePolicy>
                        <div class="update-nag">
                            <div class="update-split update-danger"><i class="glyphicon glyphicon-remove"></i></div>
                            <div class="update-text">Encryption policy does not exist! <a
                                (click)="generateEncryptionPolicy()">Generate</a></div>
                        </div>
                    </ng-template>
                </div>
            </div>
        </winery-modal-body>

        <winery-modal-footer
            [showDefaultButtons]="false">
            <button type="button" class="btn btn-primary" (click)="closeInfoModal()">Close</button>
        </winery-modal-footer>

    </winery-modal>

    <winery-modal bsModal #keypairInfoModal="bs-modal" [modalRef]="keypairInfoModal">
        <winery-modal-header [title]="'Keypair Details'"></winery-modal-header>
        <winery-modal-body>
            <div *ngIf="selectedCell && selectedCell.row.originalObject">
                <tabset>
                    <tab heading="Private Key" id="tab1">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="row">
                                    <label class="col-sm-2 control-label">Alias:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.privateKey.alias}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Algorithm:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.privateKey.algorithm}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Format:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.privateKey.keyFormat}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Size (in bits):</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.privateKey.keySizeInBits}}</p>
                                    </div>
                                </div>
                                <div *ngIf="selectedCell.row.originalObject.privateKey.base64Key" class="row">
                                    <label class="col-sm-2 control-label">Base64 encoded:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.privateKey.base64Key}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </tab>

                    <tab heading="Public Key">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="row">
                                    <label class="col-sm-2 control-label">Alias:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.publicKey.alias}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Algorithm:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.publicKey.algorithm}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Format:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.publicKey.keyFormat}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Size (in bits):</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.publicKey.keySizeInBits}}</p>
                                    </div>
                                </div>
                                <div *ngIf="selectedCell.row.originalObject.publicKey.base64Key" class="row">
                                    <label class="col-sm-2 control-label">Base64 encoded:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.publicKey.base64Key}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </tab>

                    <tab heading="Certificate">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="row">
                                    <label class="col-sm-2 control-label">Alias:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.alias}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Serial Number:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.serialNumber}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Signature Algorithm:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.sigAlgName}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Issuer:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.issuerDN}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Subject:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.subjectDN}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Subject:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.notBefore}}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 control-label">Subject:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.notAfter}}</p>
                                    </div>
                                </div>
                                <div *ngIf="selectedCell.row.originalObject.certificate.pem" class="row">
                                    <label class="col-sm-2 control-label">Base64 encoded:</label>
                                    <div class="col-sm-10">
                                        <p>{{selectedCell.row.originalObject.certificate.pem}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </tab>
                </tabset>

                <div [class.hidden]="!modalLoading">
                    <winery-loader></winery-loader>
                </div>
                <div *ngIf="!modalLoading">
                    <div *ngIf="selectedEntitySecPolicyTemplate; else generatePolicy">
                        <div class="update-nag">
                            <div class="update-split update-success"><i class="glyphicon glyphicon-ok"></i></div>
                            <div class="update-text">Signing policy for this keypair is generated.</div>
                        </div>
                    </div>
                    <ng-template #generatePolicy>
                        <div class="update-nag">
                            <div class="update-split update-danger"><i class="glyphicon glyphicon-remove"></i></div>
                            <div class="update-text">Signing policy does not exist! <a
                                (click)="generateSigningPolicy()">Generate</a></div>
                        </div>
                    </ng-template>
                </div>

            </div>
        </winery-modal-body>

        <winery-modal-footer
            [showDefaultButtons]="false">
            <button type="button" class="btn btn-primary" (click)="closeInfoModal()">Close</button>
        </winery-modal-footer>

    </winery-modal>

    <winery-modal bsModal #certificateInfoModal="bs-modal" [modalRef]="certificateInfoModal">
        <winery-modal-header [title]="'Certificate Details'"></winery-modal-header>
        <winery-modal-body>
            <div *ngIf="selectedCell">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <label class="control-label">Certificate details</label>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <label class="col-sm-2 control-label">Alias:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.alias}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Serial Number:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.serialNumber}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Issuer:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.issuerDN}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Subject:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.subjectDN}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Valid From:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.notBefore}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">Valid Until:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.notAfter}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2 control-label">PEM:</label>
                            <div class="col-sm-10">
                                <p>{{selectedCell.row.pem}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </winery-modal-body>

        <winery-modal-footer
            [showDefaultButtons]="false">
            <button type="button" class="btn btn-primary" (click)="certificateInfoModal.hide()">Close</button>
        </winery-modal-footer>

    </winery-modal>
</div>

